{"version":3,"file":"index.cjs","sources":["../src/index.ts"],"sourcesContent":["import compose from 'koa-compose';\n\nexport type PrimitiveType = string | number | boolean | null | undefined;\n\nexport type SerializableData = string | number | boolean | null | undefined | SerializableData[] |\n    { [name: string]: SerializableData };\n\nexport type ReqOptions = {\n  method?: Method | MethodLowercase,\n  base?: string,\n  headers?: Headers | Record<string, string>,\n  query?: URLSearchParams | string | Record<string, PrimitiveType> | [string, PrimitiveType][],\n  params?: Record<string, string | number | boolean>,\n  body?: ReqBody | SerializableData,\n  parseResponseBody?: boolean,\n  throwFailedResponse?: boolean,\n  use?: Middleware[],\n  useBefore?: Middleware[],\n  useAfter?: Middleware[],\n  [index: string]: any\n};\n\nexport type Method = 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH' | 'HEAD' | 'PURGE';\nexport type MethodLowercase = 'get' | 'post' | 'put' | 'delete' | 'patch' | 'head' | 'purge';\n\nexport type ReqBody = string | FormData | URLSearchParams | Blob | BufferSource | ReadableStream;\n\nexport type MiddlewareCtx = {\n  url: URL,\n\n  options: {\n    method: Method,\n    headers: Headers,\n    body: ReqBody\n  },\n\n  parseResponseBody: boolean,\n  response?: Response,\n  [name: string]: any\n};\n\nexport type Middleware = (ctx: MiddlewareCtx, next: () => Promise<any>) => Promise<any>;\n\nexport type Query = string | Record<string, PrimitiveType> | [string, PrimitiveType][];\n\nexport type FormBody = Record<string, PrimitiveType | Blob> | [string, PrimitiveType | Blob, string?][];\n\nfunction createURLSearchParams(query: Query) {\n  if (query.constructor === String) {\n    return new URLSearchParams(query);\n  }\n\n  if (query.constructor === Object) {\n    query = Object.entries(query);\n  }\n\n  const q = new URLSearchParams();\n\n  for (const [name, value] of query as [string, PrimitiveType][]) {\n    if (value !== null && value !== undefined) {\n      q.append(name, value as string);\n    }\n  }\n\n  return q;\n}\n\nfunction createFormData(data: FormBody) {\n  if (data.constructor === Object) {\n    data = Object.entries(data);\n  }\n\n  const f = new FormData();\n\n  for (const [name, value, filename] of data as [string, PrimitiveType | Blob, string?][]) {\n    if (value !== null && value !== undefined) {\n      if (filename) {\n        f.append(name, value as Blob, filename);\n      } else {\n        f.append(name, value as string);\n      }\n    }\n  }\n\n  return f;\n}\n\nclass Teleman {\n  base?: string\n\n  headers?: Headers | Record<string, string>\n\n  parseResponseBody: boolean\n\n  throwFailedResponse: boolean\n\n  middleware: Middleware[] = []\n\n  constructor({\n    base,\n    headers,\n    parseResponseBody = true,\n    throwFailedResponse = true\n  }: {\n    base?: string,\n    headers?: Headers | Record<string, string>,\n    parseResponseBody?: boolean,\n    throwFailedResponse?: boolean\n  } = {}) {\n    if (base) {\n      this.base = base;\n    } else {\n      try {\n        // defaults to document.baseURI in browser\n        this.base = document.baseURI;\n      } catch (e) {\n        // in node.js, ignore\n      }\n    }\n\n    this.headers = headers;\n    this.parseResponseBody = parseResponseBody;\n    this.throwFailedResponse = throwFailedResponse;\n  }\n\n  use(middleware: Middleware, beginning = false): void {\n    if (beginning) {\n      this.middleware.unshift(middleware);\n    } else {\n      this.middleware.push(middleware);\n    }\n  }\n\n  fetch(path: string, {\n    method = 'GET',\n    base = this.base,\n    headers,\n    query,\n    params = {},\n    body,\n    parseResponseBody = this.parseResponseBody,\n    throwFailedResponse = this.throwFailedResponse,\n    use = this.middleware,\n    useBefore = [],\n    useAfter = [],\n    ...rest\n  }: ReqOptions = {}): Promise<any> {\n    return new Promise(resolve => {\n      method = method.toUpperCase() as Method;\n      const url = new URL(path.replace(/:([a-z]\\w*)/ig, (_, w) => encodeURIComponent(params[w])), base);\n\n      if (query) {\n        if (!(query instanceof URLSearchParams)) {\n          query = createURLSearchParams(query);\n        }\n\n        query.forEach((value, name) => url.searchParams.append(name, value));\n      }\n\n      if (this.headers && headers) {\n        const h = new Headers(this.headers);\n        new Headers(headers).forEach((value, name) => h.set(name, value));\n        headers = h;\n      } else {\n        headers = new Headers(this.headers || headers || {});\n      }\n\n      if (body !== undefined && body !== null && !['GET', 'HEAD'].includes(method)) {\n        const contentType = headers.get('Content-Type') || '';\n\n        if (!contentType && body && body.constructor === Object || contentType.startsWith('application/json')) {\n          if (!headers.has('Content-Type')) {\n            headers.set('Content-Type', 'application/json');\n          }\n\n          body = JSON.stringify(body);\n        } else if (contentType.startsWith('multipart/form-data') && body && !(body instanceof FormData)) {\n          body = createFormData(body as FormBody);\n        } else if (contentType.startsWith('application/x-www-form-urlencoded') && body && !(body instanceof URLSearchParams)) {\n          body = createURLSearchParams(body as Query);\n        }\n      }\n\n      const ctx: MiddlewareCtx = {\n        url,\n\n        options: {\n          method,\n          headers,\n          body: body as ReqBody\n        },\n\n        parseResponseBody,\n        ...rest\n      };\n\n      resolve(compose([...useBefore, ...use, ...useAfter])(ctx, () =>\n        fetch(ctx.url.href, ctx.options).then(response => {\n          ctx.response = response;\n\n          let body: Promise<any> = Promise.resolve();\n\n          if (parseResponseBody && ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'PURGE'].includes(ctx.options.method.toUpperCase())) {\n            const responseType = response.headers.get('Content-Type');\n\n            if (responseType) {\n              if (responseType.startsWith('application/json')) {\n                body = response.json();\n              } else if (responseType.startsWith('text/')) {\n                body = response.text();\n              } else if (responseType.startsWith('multipart/form-data')) {\n                body = response.formData();\n              }\n            }\n          }\n\n          if (response.ok || !throwFailedResponse) {\n            return body;\n          } else {\n            return body.then(e => {\n              throw e;\n            });\n          }\n        })\n      ));\n    });\n  }\n\n  get(path: string, query?: Query, options?: ReqOptions): Promise<any> {\n    return this.fetch(path, {\n      ...options,\n      method: 'GET',\n      query\n    });\n  }\n\n  post(path: string, body?: ReqBody | SerializableData, options?: ReqOptions): Promise<any> {\n    return this.fetch(path, {\n      ...options,\n      method: 'POST',\n      body\n    });\n  }\n\n  put(path: string, body?: ReqBody | SerializableData, options?: ReqOptions): Promise<any> {\n    return this.fetch(path, {\n      ...options,\n      method: 'PUT',\n      body\n    });\n  }\n\n  patch(path: string, body?: ReqBody | SerializableData, options?: ReqOptions): Promise<any> {\n    return this.fetch(path, {\n      ...options,\n      method: 'PATCH',\n      body\n    });\n  }\n\n  delete(path: string, query?: Query, options?: ReqOptions): Promise<any> {\n    return this.fetch(path, {\n      ...options,\n      method: 'DELETE',\n      query\n    });\n  }\n\n  head(path: string, query?: Query, options?: ReqOptions): Promise<any> {\n    return this.fetch(path, {\n      ...options,\n      method: 'HEAD',\n      query\n    });\n  }\n\n  purge(path: string, query?: Query, options?: ReqOptions): Promise<any> {\n    return this.fetch(path, {\n      ...options,\n      method: 'PURGE',\n      query\n    });\n  }\n}\n\nexport default Teleman;\nexport { Teleman };\nexport const teleman = new Teleman();\n"],"names":["compose"],"mappings":"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"}